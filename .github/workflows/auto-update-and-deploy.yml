name: Auto Update & Deploy

on:
  push:
    branches: [ "main" ]
    # 画像やREADMEだけの変更では走らないようにしたい場合は下を有効化
    # paths-ignore:
    #   - "**/*.md"
    #   - "**/*.png"
    #   - "**/*.jpg"
  workflow_dispatch: {}     # 手動実行ボタン
  schedule:
    - cron: "0 */6 * * *"   # 6時間に1回ヘルスチェック的に回す（任意）

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (if requirements.txt exists)
        if: hashFiles('**/requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 任意: テストがあれば実行（なければスキップ）
      - name: Run tests (if tests/ exists)
        if: hashFiles('tests/**') != ''
        run: |
          python -m pytest -q

      - name: Trigger Render deploy (via Deploy Hook)
        env:
          HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$HOOK" ]; then
            echo "❌ RENDER_DEPLOY_HOOK is not set"; exit 1
          fi
          echo "🚀 Triggering Render deploy…"
          # リトライ付き
          for i in 1 2 3; do
            code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" -X POST "$HOOK") || true
            echo "HTTP $code"
            test "$code" = "200" && break
            echo "Retrying in 10s…"; sleep 10
          done
          echo "Response:"; tail -c 1000 /tmp/resp.txt
          test "$code" = "200" || (echo "Deploy hook failed" && exit 1)