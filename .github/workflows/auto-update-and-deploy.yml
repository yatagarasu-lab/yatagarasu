name: Auto Update & Deploy

on:
  push:
    branches: [ "main" ]
    # ç”»åƒã‚„READMEã ã‘ã®å¤‰æ›´ã§ã¯èµ°ã‚‰ãªã„ã‚ˆã†ã«ã—ãŸã„å ´åˆã¯ä¸‹ã‚’æœ‰åŠ¹åŒ–
    # paths-ignore:
    #   - "**/*.md"
    #   - "**/*.png"
    #   - "**/*.jpg"
  workflow_dispatch: {}     # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³
  schedule:
    - cron: "0 */6 * * *"   # 6æ™‚é–“ã«1å›ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çš„ã«å›ã™ï¼ˆä»»æ„ï¼‰

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (if requirements.txt exists)
        if: hashFiles('**/requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ä»»æ„: ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°å®Ÿè¡Œï¼ˆãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      - name: Run tests (if tests/ exists)
        if: hashFiles('tests/**') != ''
        run: |
          python -m pytest -q

      - name: Trigger Render deploy (via Deploy Hook)
        env:
          HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$HOOK" ]; then
            echo "âŒ RENDER_DEPLOY_HOOK is not set"; exit 1
          fi
          echo "ğŸš€ Triggering Render deployâ€¦"
          # ãƒªãƒˆãƒ©ã‚¤ä»˜ã
          for i in 1 2 3; do
            code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" -X POST "$HOOK") || true
            echo "HTTP $code"
            test "$code" = "200" && break
            echo "Retrying in 10sâ€¦"; sleep 10
          done
          echo "Response:"; tail -c 1000 /tmp/resp.txt
          test "$code" = "200" || (echo "Deploy hook failed" && exit 1)